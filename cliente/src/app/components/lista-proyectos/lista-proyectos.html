<ul class="nav nav-tabs mb-4 border-bottom-0" *ngIf="tieneCancelados()">
  <li class="nav-item">
    <a class="nav-link" [class.active]="tabActual === 'generales'" (click)="tabActual = 'generales'"
      style="cursor: pointer;">
      <i class></i>General
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link text-danger" [class.active]="tabActual === 'cancelados'" (click)="tabActual = 'cancelados'"
      style="cursor: pointer;">
      <i class></i>Cancelados
    </a>
  </li>
</ul>
<div *ngIf="proyectos.length > 0; else noProyectos" class="row mt-3">
  <div class="col-md-6 mb-3" *ngFor="let proyecto of proyectosFiltrados">
    <div class="card h-100 shadow-sm border-0 rounded-4 hoverable">
      <div class="card-body d-flex flex-column">

        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="card-title mb-0 me-2">{{ proyecto.nombre }}</h5>
          <span *ngIf="proyecto.estado === 'cancelado'" class="badge bg-danger mt-1">Cancelado</span>

          <div *ngIf="esProfesor && !claseArchivada && proyecto.estado !== 'cancelado'" class="d-flex gap-1">
            <button class="btn btn-outline-secondary btn-sm p-1 px-2" (click)="abrirModalEditar(proyecto)"
              data-bs-toggle="modal" data-bs-target="#editarProyectoModal" title="Editar Proyecto">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm p-1 px-2" (click)="deleteProyecto(proyecto._id)"
              title="Eliminar Proyecto">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>

        <h6 class="card-subtitle mb-2 text-muted">{{ proyecto.tipoProyecto.nombre }}</h6>
        <p class="card-text">
          <small class="text-muted">
            Entrega: {{ proyecto.fechaEntrega | date:'dd/MM/yyyy':'UTC' }}
          </small>
        </p>
        <p *ngIf="proyecto.descripcion" class="text-secondary">{{ proyecto.descripcion }}</p>

        <div class="mt-auto d-flex flex-column gap-2">

          <ng-container *ngIf="esProfesor ">
            <button class="btn btn-primary btn-sm w-100" (click)="verEntregas(proyecto._id)">
              <i class="bi bi-folder2-open me-2"></i>Ver todas las entregas
            </button>

            <a *ngIf="proyecto.estado !== 'cancelado' && !claseArchivada"
              [routerLink]="['/reporte-aprobadas', proyecto._id]"
              class="d-block text-center mt-2 text-success fw-bold text-decoration-underline cursor-pointer small">
              Ver listado de alumnos aprobados
            </a>
          </ng-container>

          <ng-container *ngIf="!esProfesor">
            <ng-container *ngIf="!proyecto.entregado && proyecto.estado !== 'cancelado' && !claseArchivada">
              <ng-container *ngIf="!haVencido(proyecto); else fechaVencida">
                <button class="btn btn-success btn-sm w-100" (click)="toggleEntrega(proyecto._id)">
                  Entregar proyecto
                </button>
              </ng-container>
              <ng-template #fechaVencida>
                <button class="btn btn-danger btn-sm w-100" disabled>
                  Plazo de entrega vencido
                </button>
              </ng-template>
            </ng-container>

            <ng-container *ngIf="proyecto.entregado" [ngSwitch]="proyecto.entrega?.estado">

              <div *ngSwitchCase="'aprobada'" class="d-flex flex-column align-items-start gap-2 w-100">
                <span class="badge bg-success">Entrega Aprobada</span>
                <div class="d-flex gap-2 w-100">
                  <button class="btn btn-outline-success btn-sm flex-grow-1" data-bs-toggle="modal"
                    data-bs-target="#correccionModal" (click)="abrirModalCorreccion(proyecto)">
                    <i class="bi bi-check-circle me-1"></i>Ver Corrección
                  </button>
                  <button class="btn btn-light btn-sm border" data-bs-toggle="modal" data-bs-target="#verEntregaModal"
                    (click)="verMiEntrega(proyecto)">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div *ngSwitchCase="'desaprobada'" class="d-flex flex-column align-items-start gap-2 w-100">
                <span class="badge bg-warning text-dark">Entrega desaprobada</span>
                <div class="d-flex gap-2 w-100">
                  <button class="btn btn-outline-warning text-dark btn-sm flex-grow-1" data-bs-toggle="modal"
                    data-bs-target="#correccionModal" (click)="abrirModalCorreccion(proyecto)">
                    <i class="bi bi-exclamation-circle me-1"></i>Ver Corrección
                  </button>
                  <button class="btn btn-light btn-sm border" data-bs-toggle="modal" data-bs-target="#verEntregaModal"
                    (click)="verMiEntrega(proyecto)">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div *ngSwitchCase="'pendiente'" class="d-flex flex-column align-items-start gap-1 w-100">
                <span class="badge bg-primary">Proyecto Entregado</span>
                <small class="text-muted">Pendiente de aprobación</small>

                <div class="d-flex gap-2 w-100 mt-1">
                  <button class="btn btn-light btn-sm border flex-grow-1" data-bs-toggle="modal"
                    data-bs-target="#verEntregaModal" (click)="verMiEntrega(proyecto)">
                    <i class="bi bi-eye me-1"></i> Ver entrega
                  </button>

                  <ng-container *ngIf="proyecto.estado !== 'cancelado' && !claseArchivada">
                    <button class="btn btn-outline-warning btn-sm" (click)="iniciarEdicion(proyecto)"
                      title="Editar entrega">
                      <i class="bi bi-pencil"></i>
                    </button>

                    <button class="btn btn-outline-danger btn-sm"
                      (click)="deleteEntrega(proyecto._id, proyecto.entrega?._id || '')" title="Eliminar entrega">
                      <i class="bi bi-trash"></i>
                    </button>
                  </ng-container>
                </div>
              </div>

              <ng-container *ngIf="!proyecto.entregado || proyectoEnEdicionId === proyecto._id">
                <div class="mt-3 p-3 border rounded bg-light w-100">
                  <div class="mb-3">
                    <textarea class="form-control" rows="3" [(ngModel)]="comentario"
                      placeholder="Escribe un comentario..."></textarea>
                  </div>
                  <div class="mb-3">
                    <input type="file" class="form-control" (change)="onFileSelected($event)">
                  </div>
                  <small class="text-muted d-block mb-2" *ngIf="proyectoEnEdicionId === proyecto._id">
                    Si no desea seleccionar un archivo nuevo, se mantendrá el anterior.
                  </small>

                  <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm flex-grow-1" (click)="entregarProyecto(proyecto._id)"
                      [disabled]="loadingEntrega">
                      <ng-container *ngIf="!loadingEntrega">
                        {{ proyectoEnEdicionId === proyecto._id ? 'Guardar Cambios' : 'Entregar Proyecto' }}
                      </ng-container>
                      <ng-container *ngIf="loadingEntrega">
                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        Subiendo...
                      </ng-container>
                    </button>

                    <button *ngIf="proyectoEnEdicionId === proyecto._id" class="btn btn-secondary btn-sm"
                      (click)="cancelarEdicion()" [disabled]="loadingEntrega">
                      Cancelar
                    </button>
                  </div>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>

        </div>

        <div *ngIf="proyectoExpandidoId === proyecto._id" class="mt-3 p-3 border rounded bg-light">
          <div class="mb-2">
            <label>Comentario o enlace:</label>
            <textarea class="form-control" [(ngModel)]="comentario" rows="2"
              placeholder="Escribe tu comentario o pega un link"></textarea>
          </div>
          <div class="mb-2">
            <label>Archivo (PDF o imagen):</label>
            <input type="file" class="form-control" (change)="onFileSelected($event)"
              accept=".pdf,.png,.jpg,.jpeg,.gif">
          </div>

          <button class="btn btn-primary btn-sm mt-2 w-100" (click)="entregarProyecto(proyecto._id)"
            [disabled]="loadingEntrega">
            <ng-container *ngIf="!loadingEntrega">Entregar</ng-container>
            <ng-container *ngIf="loadingEntrega">
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              Subiendo...
            </ng-container>
          </button>

          <div *ngIf="errorMessage" class="text-danger mt-2 small">{{ errorMessage }}</div>
        </div>

      </div>
    </div>
  </div>
</div>

<ng-template #noProyectos>
  <p class="text-muted text-center mt-4">Aquí se mostrarán los proyectos de la clase.</p>
</ng-template>

<div class="modal fade" id="editarProyectoModal" #editarModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" *ngIf="proyectoSeleccionado">
      <div class="modal-header">
        <h5 class="modal-title">Editar Proyecto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="mb-3">
          <label for="nombreProyecto" class="form-label">Nombre del proyecto</label>
          <input type="text" class="form-control" id="nombreProyecto" [(ngModel)]="proyectoSeleccionado.nombre">
        </div>

        <div class="mb-3">
          <label for="descProyecto" class="form-label">Descripción</label>
          <textarea class="form-control" id="descProyecto" rows="3"
            [(ngModel)]="proyectoSeleccionado.descripcion"></textarea>
        </div>

        <div class="mb-3">
          <label for="fechaProyecto" class="form-label">Fecha de Entrega</label>
          <input type="date" class="form-control" id="fechaProyecto"
            [ngModel]="proyectoSeleccionado.fechaEntrega | date:'yyyy-MM-dd'"
            (ngModelChange)="proyectoSeleccionado.fechaEntrega = $event">
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="guardarCambios()">Guardar Cambios</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="correccionModal" tabindex="-1" aria-labelledby="correccionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden" *ngIf="correccionSeleccionada">

      <div class="modal-header bg-primary text-white p-4">
        <div class="w-100">
          <h5 class="modal-title fw-bold mb-1" id="correccionModalLabel">
            <i class="bi bi-journal-check me-2"></i>
            {{ proyectoParaCorreccion?.nombre || 'Detalle de la Corrección' }}
          </h5>
          <small class="text-white-50 d-block">
            Fecha de entrega: {{ proyectoParaCorreccion?.entrega?.fechaEntrega | date:'dd/MM/yyyy' }}
          </small>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4 bg-light">
        <div class="text-center mb-4">
          <h6 class="text-uppercase text-secondary fw-bold text-spacing-2 mb-3">Nota Final</h6>

          <div class="d-inline-flex align-items-center justify-content-center rounded-circle shadow-sm"
            [ngClass]="(correccionSeleccionada.nota || 0) >= 6 ? 'bg-success text-white' : 'bg-danger text-white'"
            style="width: 110px; height: 110px;">
            <span class="display-3 fw-bold">{{ correccionSeleccionada.nota }}</span>
          </div>
        </div>

        <div class="card border-0 shadow-sm rounded-3">
          <div class="card-body p-3">
            <h6 class="fw-bold text-dark border-bottom pb-2 mb-2">
              <i class="bi bi-chat-left-quote-fill me-2 text-primary"></i>Comentario del docente:
            </h6>
            <p class="card-text text-secondary fst-italic">
              {{ correccionSeleccionada.comentario || 'Sin comentarios adicionales.' }}
            </p>
          </div>
        </div>
      </div>

      <div class="modal-footer border-top-0 bg-light px-4 pb-4">
        <button type="button" class="btn btn-secondary w-100 py-2 fw-semibold rounded-3" data-bs-dismiss="modal">
          Entendido
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="verEntregaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">

      <div class="modal-header bg-light border-bottom-0">
        <div>
          <h5 class="modal-title fw-bold text-dark">
            <i class="bi bi-archive me-2 text-secondary"></i>Tu Entrega
          </h5>
          <small class="text-muted">
            Para el proyecto: <strong>{{ proyectoDeLaEntrega?.nombre }}</strong>
          </small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-4">

        <div class="mb-4 d-flex align-items-center text-muted">
          <i class="bi bi-calendar3 me-2"></i>
          Enviado el: {{ entregaSeleccionada?.fechaEntrega | date:'dd/MM/yyyy - HH:mm' }} hs
        </div>

        <div class="card mb-3 border-0 bg-primary bg-opacity-10" *ngIf="entregaSeleccionada?.archivoUrl">
          <div class="card-body d-flex align-items-center">
            <div class="bg-white p-2 rounded-circle me-3 shadow-sm text-primary">
              <i class="bi bi-file-earmark-text fs-4"></i>
            </div>
            <div class="flex-grow-1">
              <h6 class="mb-0 fw-bold text-primary">Archivo Adjunto</h6>
              <small class="text-primary text-opacity-75">Click para descargar</small>
            </div>
            <a [href]="serverUrl + entregaSeleccionada?.archivoUrl" target="_blank"
              class="btn btn-sm btn-primary rounded-pill px-3">
              <i class="bi bi-download me-1"></i> Descargar
            </a>
          </div>
        </div>

        <div *ngIf="!entregaSeleccionada?.archivoUrl" class="text-muted fst-italic mb-3 small">
          <i class="bi bi-info-circle me-1"></i> No se adjuntó ningún archivo.
        </div>

        <div class="mt-4">
          <label class="fw-bold text-secondary mb-2 small text-uppercase">Tu Comentario:</label>
          <div class="p-3 bg-light rounded border-start border-4 border-secondary">
            {{ entregaSeleccionada?.comentario || 'No agregaste ningún comentario.' }}
          </div>
        </div>

      </div>

      <div class="modal-footer border-top-0 pt-0">
        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>